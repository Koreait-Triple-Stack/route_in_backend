<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.triple_stack.route_in_backend.mapper.AIRecommendMapper">
    <resultMap id="AIRecommendResultMap" type="com.triple_stack.route_in_backend.entity.AIRecommend">
        <id property="aiRecommendId" column="ai_recommend_id"  />
        <result property="userId" column="user_id" />
        <result property="aiResp" column="ai_resp" typeHandler="com.triple_stack.route_in_backend.security.handler.RecommendationTypeHandler" />
        <result property="createDt" column="create_dt" />
    </resultMap>

    <resultMap id="AIRecommendReqResultMap" type="com.triple_stack.route_in_backend.dto.ai.AIRecommendReqDto">
        <id property="userId" column="user_id"  />
        <association property="userProfile" javaType="com.triple_stack.route_in_backend.dto.ai.AIRecommendReqDto$UserProfileDto">
            <result property="birthDate" column="birth_date" />
            <result property="gender" column="gender" />
        </association>

        <association property="bodyInfo" javaType="com.triple_stack.route_in_backend.dto.ai.AIRecommendReqDto$BodyInfoDto">
            <result property="height" column="height" />
            <result property="weight" column="weight" />
            <result property="skeletalMuscleMass" column="skeletal_muscle" />
            <result property="bodyFatMass" column="body_fat_mass" />
            <result property="monthDt" column="month_dt" />
        </association>

        <association property="location" javaType="com.triple_stack.route_in_backend.dto.ai.AIRecommendReqDto$LocationDto">
            <result property="zipCode" column="zip_code" />
            <result property="lat" column="lat" />
            <result property="lng" column="lng" />
        </association>

        <association property="workoutHistory" javaType="com.triple_stack.route_in_backend.dto.ai.AIRecommendReqDto$WorkoutHistoryDto">
            <result property="currentRun" column="current_run" />
            <result property="weeklyRun" column="weekly_run" />
            <result property="exercise" column="exercise" />
            <result property="weekday" column="weekday" />
        </association>

        <collection property="course" resultMap="CourseResultMap" />
    </resultMap>

    <resultMap id="CourseResultMap" type="com.triple_stack.route_in_backend.entity.Course">
        <id property="courseId" column="course_id"/>
        <result property="userId" column="user_id"/>
        <result property="boardId" column="board_id"/>
        <result property="courseName" column="course_name"/>
        <result property="distanceM" column="distance_m"/>
        <result property="centerLat" column="center_lat"/>
        <result property="centerLng" column="center_lng"/>
        <result property="region" column="region"/>
        <result property="favorite" column="favorite"/>
        <result property="createDt" column="create_dt"/>
        <result property="updateDt" column="update_dt"/>
    </resultMap>

    <select id="getAIContext" resultMap="AIRecommendReqResultMap">
        select
            ut.birth_date,
            ut.gender,
            ut.height,
            ut.weight,
            it.skeletal_muscle_mass,
            it.body_fat_mass,
            it.month_dt,
            at.zip_code,
            cpt.lat,
            cpt.lng,
            ut.current_run,
            ut.weekly_run,
            rt.exercise,
            rt.weekday,
            ct.*
        from
            user_tb ut
            join in_body_tb it on (ut.user_id = it.user_id)
            join address_tb at on (it.user_id = at.user_id)
            join routine_tb rt on (at.user_id = rt.user_id)
            join course_tb ct on (rt.user_id = ct.user_id)
            join course_point_tb cpt on (ct.course_id = cpt.course_id)
        where
            ut.user_id = #{userId}
    </select>

    <select id="getRecommendationByUserId" resultMap="AIRecommendResultMap">
        select
            *
        from
            ai_recommend_tb
        where
            user_id = #{userId}
    </select>

    <insert id="addRecommendation">
        insert into
            ai_recommend_tb
        values
            (0, #{userId}, #{aiResp, typeHandler=com.triple_stack.route_in_backend.security.handler.RecommendationTypeHandler}, now())
    </insert>
</mapper>