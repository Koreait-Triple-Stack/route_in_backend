<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.triple_stack.route_in_backend.mapper.MessageMapper">
    <resultMap id="MessageResultMap" type="com.triple_stack.route_in_backend.entity.Message">
        <id property="messageId" column="message_id"/>
        <result property="roomId" column="room_id"/>
        <result property="senderId" column="sender_id"/>
        <result property="type" column="type"/>
        <result property="content" column="content"/>
        <result property="createDt" column="create_dt"/>
        <result property="profileImg" column="profile_img"/>
        <result property="username" column="username"/>
        <result property="unreadCnt" column="unread_cnt"/>
    </resultMap>

    <insert id="addMessage" useGeneratedKeys="true" keyProperty="messageId">
        insert into
            message_tb
        values
            (0, #{roomId}, #{senderId}, #{type}, #{content}, now());
    </insert>

    <update id="changeMessage">
        update
            message_tb
        set
            sender_id = #{senderId},
            content = #{content}
        where
            message_id = #{messageId};
    </update>

    <select id="getMessageListInfinite" resultMap="MessageResultMap">
        select
            message_tb.*,
            user_tb.profile_img as profile_img,
            user_tb.username as username,
            (
            select count(*)
            from room_participant_tb rpt2
            join room_read_tb rrt
            on rrt.room_id = rpt2.room_id
            and rrt.user_id = rpt2.user_id
            where rpt2.room_id = message_tb.room_id
            and rpt2.left_dt is null
            and message_tb.sender_id is not null
            and rpt2.user_id != message_tb.sender_id
            and rrt.last_read_message_id &lt; message_tb.message_id
            and message_tb.create_dt > rpt2.joined_dt
            ) as unread_cnt
        from message_tb
            left join user_tb
            on user_tb.user_id = message_tb.sender_id
            join room_participant_tb rpt
            on rpt.room_id = message_tb.room_id
            and rpt.user_id = #{userId}
            where
            message_tb.room_id = #{roomId}
            and message_tb.create_dt > rpt.joined_dt
            <if test="cursorCreateDt != null and cursorMessageId != null">
                and (
                message_tb.create_dt &lt; #{cursorCreateDt}
                or (message_tb.create_dt = #{cursorCreateDt} and message_tb.message_id &lt; #{cursorMessageId})
                )
            </if>
        order by
            message_tb.create_dt desc,
            message_tb.message_id desc
            limit #{limitPlusOne};
    </select>

    <select id="getMessageByMessageId" resultMap="MessageResultMap">
        select
            *
        from
            message_tb
        where
            message_id = #{messageId};
    </select>

    <select id="getLastMessageIdByRoomId" resultType="int">
        select
            IFNULL(MAX(message_id), 0)
        from
            message_tb
        where
            room_id = #{roomId};
    </select>
</mapper>