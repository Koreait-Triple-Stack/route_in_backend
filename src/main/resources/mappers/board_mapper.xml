<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.triple_stack.route_in_backend.mapper.BoardMapper">
    <resultMap id="BoardRespResultMap" type="com.triple_stack.route_in_backend.dto.board.BoardRespDto">
        <id property="boardId" column="board_id"/>
        <result property="userId" column="user_id"/>
        <result property="type" column="type"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="tags" column="tags"
                typeHandler="com.triple_stack.route_in_backend.security.handler.JsonTypeHandler"/>
        <result property="recommendCnt" column="recommend_cnt"/>
        <result property="username" column="username"/>
        <result property="birthDate" column="birth_date"/>
        <result property="profileImg" column="profile_img"/>
        <result property="createDt" column="create_dt"/>
        <result property="updateDt" column="update_dt"/>
    </resultMap>

    <resultMap id="BoardDetailRespResultMap" type="com.triple_stack.route_in_backend.dto.board.BoardDetailRespDto">
        <id property="boardId" column="board_id"/>
        <result property="userId" column="user_id"/>
        <result property="type" column="type"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="tags" column="tags"
                typeHandler="com.triple_stack.route_in_backend.security.handler.JsonTypeHandler"/>
        <result property="recommendCnt" column="recommend_cnt"/>
        <result property="username" column="username"/>
        <result property="birthDate" column="birth_date"/>
        <result property="profileImg" column="profile_img"/>
        <result property="createDt" column="create_dt"/>
        <result property="updateDt" column="update_dt"/>
        <association property="course" resultMap="CourseResultMap"/>
        <collection property="routines" resultMap="RoutineResultMap"/>
    </resultMap>

    <resultMap id="RoutineResultMap" type="com.triple_stack.route_in_backend.entity.Routine">
        <id property="routineId" column="routine_id"/>
        <result property="boardId" column="rt_board_id"/>
        <result property="weekday" column="weekday"/>
        <result property="exercise" column="exercise"/>
        <result property="checked" column="checked"/>
    </resultMap>

    <resultMap id="CourseResultMap" type="com.triple_stack.route_in_backend.entity.Course">
        <id property="courseId" column="course_id"/>
        <result property="boardId" column="ct_board_id"/>
        <result property="courseName" column="course_name"/>
        <result property="distanceM" column="distance_m"/>
        <result property="centerLat" column="center_lat"/>
        <result property="centerLng" column="center_lng"/>
        <result property="region" column="region"/>
        <result property="favorite" column="favorite"/>
        <collection property="points" resultMap="CoursePointResultMap"/>
    </resultMap>

    <resultMap id="CoursePointResultMap" type="com.triple_stack.route_in_backend.entity.CoursePoint">
        <id property="pointId" column="point_id"/>
        <result property="courseId" column="cpt_course_id"/>
        <result property="seq" column="seq"/>
        <result property="lat" column="lat"/>
        <result property="lng" column="lng"/>
    </resultMap>

    <insert id="addBoard"
            parameterType="com.triple_stack.route_in_backend.entity.Board"
            useGeneratedKeys="true"
            keyProperty="boardId">
        insert into board_tb
        (user_id, type, title, content, tags, recommend_cnt, create_dt, update_dt)
        values
            (#{userId},
            #{type},
            #{title},
            #{content},
            #{tags, typeHandler=com.triple_stack.route_in_backend.security.handler.JsonTypeHandler},
            0,
            now(),
            null);
    </insert>

    <select id="getBoardList" resultMap="BoardRespResultMap">
        select
            bt.board_id,
            bt.user_id,
            bt.type,
            bt.title,
            bt.content,
            bt.tags,
            bt.recommend_cnt,
            bt.create_dt,
            bt.update_dt,
            ut.username,
            ut.birth_date,
            ut.profile_img
        from
            board_tb bt
            join user_tb ut on bt.user_id = ut.user_id
        where
            board_id != 0
        order by
            bt.create_dt desc,
            bt.board_id desc;
    </select>

    <select id="getBoardByRecommendCnt" resultMap="BoardRespResultMap">
        select
            *
        from
            board_tb
        where
            type = "COURSE"
        ORDER BY recommend_cnt DESC
        LIMIT 5;
    </select>

    <select id="getBoardInfinite" resultMap="BoardRespResultMap">
        select
        bt.board_id,
        bt.user_id,
        bt.type,
        bt.title,
        bt.content,
        bt.tags,
        bt.recommend_cnt,
        ut.username,
        ut.birth_date,
        ut.profile_img,
        bt.create_dt,
        bt.update_dt
        from
        board_tb bt
        join user_tb ut on bt.user_id = ut.user_id

        <where>
            <if test="type != null and type != 'ALL'">
                AND bt.type = #{type}
            </if>

            <choose>
                <when test="sort == null or sort == 'LATEST'">
                    <if test="cursorCreateDt != null and cursorBoardId != null">
                        AND (
                        bt.create_dt &lt; #{cursorCreateDt}
                        OR (bt.create_dt = #{cursorCreateDt} AND bt.board_id &lt; #{cursorBoardId})
                        )
                    </if>
                </when>

                <when test="sort == 'RECOMMEND'">
                    <if test="cursorRecommendCnt != null and cursorBoardId != null">
                        AND (
                        bt.recommend_cnt &lt; #{cursorRecommendCnt}
                        OR (bt.recommend_cnt = #{cursorRecommendCnt} AND bt.board_id &lt; #{cursorBoardId})
                        )
                    </if>
                </when>
            </choose>

            <if test="type == 'COURSE'">
                <if test="tags != null and tags.size() &gt;=1 and tags[0] != null and tags[0] != ''">
                    AND JSON_UNQUOTE(JSON_EXTRACT(bt.tags, '$[0]'))
                    LIKE CONCAT('%', #{tags[0]}, '%')
                </if>

                <if test="tags != null and tags.size() &gt;= 2 and tags[1] != null and tags[1] != '' and tags[1] != 0">
                    AND CAST(JSON_UNQUOTE(JSON_EXTRACT(bt.tags, '$[1]')) AS UNSIGNED)
                    &lt;= CAST(#{tags[1]} AS UNSIGNED)
                </if>
            </if>

            <if test="type == 'ROUTINE' and tags != null and tags.size() &gt; 0">
                AND (
                <foreach collection="tags" item="tag" separator=" OR ">
                    JSON_CONTAINS(bt.tags, JSON_QUOTE(#{tag}))
                </foreach>
                )
            </if>
        </where>

        <choose>
            <when test="sort == 'RECOMMEND'">
                order by
                bt.recommend_cnt desc,
                bt.board_id desc
            </when>
            <otherwise>
                order by
                bt.create_dt desc,
                bt.board_id desc
            </otherwise>
        </choose>
        limit #{limitPlusOne};
    </select>

    <!-- boardId로 단건 조회 -->
    <select id="getBoardByBoardId" resultMap="BoardDetailRespResultMap">
        select
            bt.board_id,
            bt.user_id,
            bt.type,
            bt.title,
            bt.content,
            bt.tags,
            bt.recommend_cnt,
            ut.username,
            ut.birth_date,
            ut.profile_img,
            bt.create_dt,
            bt.update_dt,
            ct.course_id,
            ct.board_id as ct_board_id,
            ct.course_name,
            ct.distance_m,
            ct.center_lat,
            ct.center_lng,
            ct.region,
            ct.favorite,
            rt.routine_id,
            rt.board_id as rt_board_id,
            rt.weekday,
            rt.exercise,
            rt.checked,
            cpt.point_id,
            cpt.course_id as cpt_course_id,
            cpt.seq,
            cpt.lat,
            cpt.lng
        from
            board_tb bt
            join user_tb ut on bt.user_id = ut.user_id
            left join course_tb ct on ct.board_id = bt.board_id
            left join routine_tb rt on rt.board_id = bt.board_id
            left join course_point_tb cpt on cpt.course_id = ct.course_id
        where
            bt.board_id = #{boardId};
    </select>

    <!-- 키워드 검색 -->
    <select id="getBoardListByKeyword" resultMap="BoardRespResultMap">
        select
            bt.board_id,
            bt.user_id,
            bt.type,
            bt.title,
            bt.content,
            bt.tags,
            bt.recommend_cnt,
            ut.username,
            ut.birth_date,
            ut.profile_img,
            bt.create_dt,
            bt.update_dt
        from
            board_tb bt
            join user_tb ut on bt.user_id = ut.user_id
        where
            bt.title like concat('%', #{keyword}, '%')
            or bt.content like concat('%', #{keyword}, '%')
            or JSON_SEARCH(bt.tags, 'one', #{keyword}) is not null
        order by
            bt.recommend_cnt desc,
            bt.create_dt desc,
            bt.board_id desc;
    </select>

    <!-- userId로 조회 -->
    <select id="getBoardListByUserId" resultMap="BoardRespResultMap">
        select
            bt.board_id,
            bt.user_id,
            bt.type,
            bt.title,
            bt.content,
            bt.tags,
            bt.recommend_cnt,
            ut.username,
            ut.birth_date,
            ut.profile_img,
            bt.create_dt,
            bt.update_dt
        from
            board_tb bt
            join user_tb ut on bt.user_id = ut.user_id
        where
            bt.user_id = #{userId}
        order by
            bt.create_dt desc,
            bt.board_id desc;
    </select>

    <!-- 게시글 수정 -->
    <update id="updateBoard" parameterType="com.triple_stack.route_in_backend.entity.Board">
        update board_tb
        set
            title = #{title},
            content = #{content},
            tags = #{tags, typeHandler=com.triple_stack.route_in_backend.security.handler.JsonTypeHandler},
            update_dt = now()
        where
            board_id = #{boardId};
    </update>

    <!-- 게시글 삭제 -->
    <delete id="removeBoard">
        delete from board_tb
        where board_id = #{boardId};
    </delete>

    <update id="plusRecommend">
        update
            board_tb
        set
            recommend_cnt = recommend_cnt + 1
        where
            board_id = #{boardId};
    </update>

    <update id="minusRecommend">
        update
            board_tb
        set
            recommend_cnt = recommend_cnt - 1
        where
            board_id = #{boardId};
    </update>

</mapper>

