<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.triple_stack.route_in_backend.mapper.BoardMapper">
    <resultMap id="BoardRespResultMap" type="com.triple_stack.route_in_backend.dto.board.BoardRespDto">
        <id property="boardId" column="board_id"/>
        <result property="userId" column="user_id"/>
        <result property="type" column="type"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="tags" column="tags"
                typeHandler="com.triple_stack.route_in_backend.security.handler.JsonTypeHandler"/>
        <result property="recommendCnt" column="recommend_cnt"/>
        <result property="username" column="username"/>
        <result property="birthDate" column="birth_date"/>
        <result property="profileImg" column="profile_img"/>
        <result property="createDt" column="create_dt"/>
        <result property="updateDt" column="update_dt"/>
    </resultMap>

    <resultMap id="RoutineResultMap" type="com.triple_stack.route_in_backend.entity.Routine">
        <id property="routineId" column="routineId"/>
        <result property="monday" column="monday" typeHandler="com.triple_stack.route_in_backend.security.handler.JsonTypeHandler"/>
        <result property="tuesday" column="tuesday" typeHandler="com.triple_stack.route_in_backend.security.handler.JsonTypeHandler"/>
        <result property="wednesday" column="wednesday" typeHandler="com.triple_stack.route_in_backend.security.handler.JsonTypeHandler"/>
        <result property="thursday" column="thursday" typeHandler="com.triple_stack.route_in_backend.security.handler.JsonTypeHandler"/>
        <result property="friday" column="friday" typeHandler="com.triple_stack.route_in_backend.security.handler.JsonTypeHandler"/>
        <result property="saturday" column="saturday" typeHandler="com.triple_stack.route_in_backend.security.handler.JsonTypeHandler"/>
        <result property="sunday" column="sunday" typeHandler="com.triple_stack.route_in_backend.security.handler.JsonTypeHandler"/>
        <result property="userId" column="user_id"/>
        <result property="boardId" column="board_id"/>
    </resultMap>

    <!-- 게시글 추가 -->
    <insert id="addBoard"
            parameterType="com.triple_stack.route_in_backend.entity.Board"
            useGeneratedKeys="true"
            keyProperty="boardId">
        insert into board_tb
        (user_id, type, title, content, tags, recommend_cnt, create_dt, update_dt)
        values
            (#{userId},
            #{type},
            #{title},
            #{content},
            #{tags, typeHandler=com.triple_stack.route_in_backend.security.handler.JsonTypeHandler},
            0,
            now(),
            null);
    </insert>

    <!-- 게시글 목록 -->
    <select id="getBoardList" resultMap="BoardRespResultMap">
        select
            bt.board_id,
            bt.user_id,
            bt.type,
            bt.title,
            bt.content,
            bt.tags,
            bt.recommend_cnt,
            bt.create_dt,
            bt.update_dt,
            ut.username,
            ut.birth_date,
            ut.profile_img
        from
            board_tb bt
            join user_tb ut on bt.user_id = ut.user_id
        where
            board_id != 0
        order by
            bt.create_dt desc,
            bt.board_id desc;
    </select>

    <!-- 무한 스크롤 -->
    <select id="getBoardInfinite" resultMap="BoardRespResultMap">
        select
            bt.board_id,
            bt.user_id,
            bt.type,
            bt.title,
            bt.content,
            bt.tags,
            bt.recommend_cnt,
            ut.username,
            ut.birth_date,
            ut.profile_img,
            bt.create_dt,
            bt.update_dt
        from
            board_tb bt
            join user_tb ut on bt.user_id = ut.user_id
        <where>
            <if test="type != null and type != 'ALL'">
                AND bt.type = #{type}
            </if>

            <if test="cursorCreateDt != null and cursorBoardId != null">
                (
                bt.create_dt &lt; #{cursorCreateDt}
                or (bt.create_dt = #{cursorCreateDt} and bt.board_id &lt; #{cursorBoardId})
                )
            </if>

            <if test="type == 'COURSE'">
                <if test="tags != null and tags.size() &gt;=1 and tags[0] != null and tags[0] != ''">
                    AND JSON_UNQUOTE(JSON_EXTRACT(bt.tags, '$[0]'))
                    LIKE CONCAT('%', #{tags[0]}, '%')
                </if>

                <if test="tags != null and tags.size() &gt;= 2 and tags[1] != null and tags[1] != '' and tags[1] != 0">
                    AND CAST(JSON_UNQUOTE(JSON_EXTRACT(bt.tags, '$[1]')) AS UNSIGNED)
                    &lt;= CAST(#{tags[1]} AS UNSIGNED)
                </if>
            </if>

            <if test="type == 'ROUTINE' and tags != null and tags.size() &gt; 0">
                AND (
                <foreach collection="tags" item="tag" separator=" OR ">
                    JSON_CONTAINS(bt.tags, JSON_QUOTE(#{tag}))
                </foreach>
                )
            </if>
        </where>
        order by
            bt.create_dt desc,
            bt.board_id desc
            limit #{limitPlusOne};
    </select>

    <!-- boardId로 단건 조회 -->
    <select id="getBoardByBoardId" resultMap="BoardRespResultMap">
        select
            bt.board_id,
            bt.user_id,
            bt.type,
            bt.title,
            bt.content,
            bt.tags,
            bt.recommend_cnt,
            ut.username,
            ut.birth_date,
            ut.profile_img,
            bt.create_dt,
            bt.update_dt
        from
            board_tb bt
            join user_tb ut on bt.user_id = ut.user_id
        where
            bt.board_id = #{boardId};
    </select>

    <!-- 키워드 검색 -->
    <select id="getBoardListByKeyword" resultMap="BoardRespResultMap">
        select
            bt.board_id,
            bt.user_id,
            bt.type,
            bt.title,
            bt.content,
            bt.tags,
            bt.recommend_cnt,
            ut.username,
            ut.birth_date,
            ut.profile_img,
            bt.create_dt,
            bt.update_dt
        from
            board_tb bt
            join user_tb ut on bt.user_id = ut.user_id
        where
            bt.title like concat('%', #{keyword}, '%')
            or bt.content like concat('%', #{keyword}, '%')
            or JSON_SEARCH(bt.tags, 'one', #{keyword}) is not null
        order by
            bt.recommend_cnt desc,
            bt.create_dt desc,
            bt.board_id desc;
    </select>

    <!-- userId로 조회 -->
    <select id="getBoardListByUserId" resultMap="BoardRespResultMap">
        select
            bt.board_id,
            bt.user_id,
            bt.type,
            bt.title,
            bt.content,
            bt.tags,
            bt.recommend_cnt,
            ut.username,
            ut.birth_date,
            ut.profile_img,
            bt.create_dt,
            bt.update_dt
        from
            board_tb bt
            join user_tb ut on bt.user_id = ut.user_id
        where
            bt.user_id = #{userId}
        order by
            bt.create_dt desc,
            bt.board_id desc;
    </select>

    <!-- 게시글 수정 -->
    <update id="updateBoard" parameterType="com.triple_stack.route_in_backend.entity.Board">
        update board_tb
        set
            type = #{type},
            title = #{title},
            content = #{content},
            tags = #{tags, typeHandler=com.triple_stack.route_in_backend.security.handler.JsonTypeHandler},
            update_dt = now()
        where
            board_id = #{boardId};
    </update>

    <!-- 게시글 삭제 -->
    <delete id="removeBoard">
        delete from board_tb
        where board_id = #{boardId};
    </delete>

    <update id="plusRecommend">
        update
            board_tb
        set
            recommend_cnt = recommend_cnt + 1
        where
            board_id = #{boardId};
    </update>

    <update id="minusRecommend">
        update
            board_tb
        set
            recommend_cnt = recommend_cnt - 1
        where
            board_id = #{boardId};
    </update>

</mapper>

