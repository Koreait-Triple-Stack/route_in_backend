<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.triple_stack.route_in_backend.mapper.BoardMapper">

    <resultMap id="BoardRespResultMap" type="com.triple_stack.route_in_backend.dto.board.BoardRespDto">
        <id property="boardId" column="board_id"/>
        <result property="userId" column="user_id"/>

        <result property="type" column="type"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>

        <result property="tags" column="tag"
                typeHandler="com.triple_stack.route_in_backend.security.handler.JsonTypeHandler"/>
        <result property="recommendCnt" column="recommend_cnt"/>

        <result property="username" column="username"/>
        <result property="profileImg" column="profile_img"/>

        <result property="createDt" column="create_dt"/>
        <result property="updateDt" column="update_dt"/>
    </resultMap>

    <!-- 게시글 추가 -->
    <insert id="addBoard"
            parameterType="com.triple_stack.route_in_backend.entity.Board"
            useGeneratedKeys="true"
            keyProperty="boardId">
        insert into board_tb
        (user_id, type, title, content, tags, recommend_cnt, create_dt, update_dt)
        values
            (#{userId},
            #{type},
            #{title},
            #{content},
            #{tags, typeHandler=com.triple_stack.route_in_backend.security.handler.JsonTypeHandler},
            0,
            now(),
            null);
    </insert>

    <!-- 게시글 목록 -->
    <select id="getBoardList" resultMap="BoardRespResultMap">
        select
            bt.board_id,
            bt.user_id,
            bt.type,
            bt.title,
            bt.content,
            bt.tags,
            bt.recommend_cnt,
            bt.create_dt,
            bt.update_dt,
            ut.username,
            ut.profile_img
        from
            board_tb bt
            join user_tb ut on bt.user_id = ut.user_id
        where
            board_id != 0
        order by
            bt.create_dt desc,
            bt.board_id desc;
    </select>

    <!-- 무한 스크롤 -->
    <select id="getBoardInfinite" resultMap="BoardRespResultMap">
        select
            bt.board_id,
            bt.user_id,
            bt.type,
            bt.title,
            bt.content,
            bt.tags,
            bt.recommend_cnt,
            ut.username,
            ut.profile_img,
            bt.create_dt,
            bt.update_dt
        from
            board_tb bt
            join user_tb ut on bt.user_id = ut.user_id
        <where>
            <if test="cursorCreateDt != null and cursorBoardId != null">
                (
                bt.create_dt &lt; #{cursorCreateDt}
                or (bt.create_dt = #{cursorCreateDt} and bt.board_id &lt; #{cursorBoardId})
                )
            </if>
        </where>
        order by
            bt.create_dt desc,
            bt.board_id desc
            limit #{limitPlusOne};
    </select>

    <!-- boardId로 단건 조회 -->
    <select id="getBoardByBoardId" resultMap="BoardRespResultMap">
        select
            bt.board_id,
            bt.user_id,
            bt.type,
            bt.title,
            bt.content,
            bt.tags,
            bt.recommend_cnt,
            ut.username,
            ut.profile_img,
            bt.create_dt,
            bt.update_dt
        from
            board_tb bt
            join user_tb ut on bt.user_id = ut.user_id
        where
            bt.board_id = #{boardId};
    </select>

    <!-- 키워드 검색 -->
    <select id="getBoardListByKeyword" resultMap="BoardRespResultMap">
        select
            bt.board_id,
            bt.user_id,
            bt.type,
            bt.title,
            bt.content,
            bt.tags,
            bt.recommend_cnt,
            ut.username,
            ut.profile_img,
            bt.create_dt,
            bt.update_dt
        from
            board_tb bt
            join user_tb ut on bt.user_id = ut.user_id
        where
            bt.title like concat('%', #{keyword}, '%')
            or bt.content like concat('%', #{keyword}, '%')
            or JSON_SEARCH(bt.tag, 'one', #{keyword}) is not null
        order by
            bt.recommend_cnt desc,
            bt.create_dt desc,
            bt.board_id desc;
    </select>

    <!-- userId로 조회 -->
    <select id="getBoardListByUserId" resultMap="BoardRespResultMap">
        select
            bt.board_id,
            bt.user_id,
            bt.type,
            bt.title,
            bt.content,
            bt.tags,
            bt.recommend_cnt,
            ut.username,
            ut.profile_img,
            bt.create_dt,
            bt.update_dt
        from
            board_tb bt
            join user_tb ut on bt.user_id = ut.user_id
        where
            bt.user_id = #{userId}
        order by
            bt.create_dt desc,
            bt.board_id desc;
    </select>

    <!-- 게시글 수정 -->


    <update id="updateBoard" parameterType="com.triple_stack.route_in_backend.entity.Board">
        update board_tb
        set
            type = #{type},
            title = #{title},
            content = #{content},
            tag = #{tags, typeHandler=com.triple_stack.route_in_backend.security.handler.JsonTypeHandler},
            update_dt = now()
        where
            board_id = #{boardId};
    </update>

    <!-- 게시글 삭제 -->
    <delete id="removeBoard">
        delete from board_tb
        where board_id = #{boardId};
    </delete>

</mapper>

